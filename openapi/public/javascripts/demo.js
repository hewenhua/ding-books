var getMethod=function(f,e){var a=f.split(".");var d=e||dd;for(var c=0,b=a.length;c<b;c++){if(c===b-1){return d[a[c]]}if(typeof d[a[c]]=="undefined"){d[a[c]]={}}d=d[a[c]]}};var sleep=function(b){var a=new Date();var c=a.getTime()+b;while(true){a=new Date();if(a.getTime()>c){return}}};logger.i("Here we go...");logger.i(location.href);dd.config({agentId:_config.agentId,corpId:_config.corpId,timeStamp:_config.timeStamp,nonceStr:_config.nonceStr,signature:_config.signature,jsApiList:["runtime.info","device.notification.prompt","biz.chat.pickConversation","device.notification.confirm","device.notification.alert","device.notification.prompt","device.geolocation.get","biz.chat.open","biz.util.open","biz.user.get","biz.contact.choose","biz.telephone.call","biz.util.uploadImage","biz.util.qrcode","biz.util.scan","biz.ding.post"]});dd.userid=0;dd.ready(function(){logger.i("dd.ready rocks!");dd.runtime.info({onSuccess:function(a){logger.i("runtime info: "+JSON.stringify(a))},onFail:function(a){logger.e("fail: "+JSON.stringify(a))}});dd.device.geolocation.get({onSuccess:function(a){dd.address=a.address;dd.latitude=a.latitude;dd.longitude=a.longitude},onFail:function(a){logger.e("fail: "+JSON.stringify(a))}});dd.runtime.permission.requestAuthCode({corpId:_config.corpId,onSuccess:function(a){logger.i("authcode: "+a.code);$.ajax({url:"/openapi/sendMsg.php",type:"POST",data:{event:"get_userinfo",code:a.code,corpId:_config.corpId},dataType:"json",timeout:900,success:function(c,b,e){logger.i("data_sendMsg: "+c);var d=JSON.parse(c);if(d.errcode===0){dd.userid=d.userid;dd.username=d.name;dd.department=d.department;dd.jobnumber=d.jobnumber;dd.dingid=d.dingId;$.ajax({url:"/api/userUpdate",type:"POST",data:{userId:dd.userid,userName:dd.username,corpId:_config.corpId,jobnumber:dd.jobnumber,dingid:dd.dingid,department:dd.department,latitude:dd.latitude,longitude:dd.longitude},dataType:"json",timeout:900,success:function(h,f,i){var g=JSON.parse(h);logger.i("user data: "+g);if(g.first_login===1){dd.device.notification.alert({title:"闲书漂流",message:"每日登录，奖励1漂流币~"})}if(g.first_register===1){dd.device.notification.alert({title:"闲书漂流",message:"首次登录，奖励30漂流币~"})}if(g.user_score>0&&g.first_login===0){document.getElementById("user-score").innerHTML=g.user_score}if(g.process_login===true){}},error:function(h,g,f){logger.e(g+", "+f)}})}else{logger.e("auth error: "+c)}},error:function(d,c,b){logger.e(c+", "+b)}})},onFail:function(a){logger.e("requestAuthCode fail: "+JSON.stringify(a))}});$(".chooseonebtn").on("click",function(){dd.biz.chat.pickConversation({corpId:_config.corpId,isConfirm:"false",onSuccess:function(b){var a=b;if(a){console.log(a.cid);dd.device.notification.prompt({message:"发送消息",title:a.title,buttonLabels:["发送","取消"],onSuccess:function(c){var d=c.value;if(d==""){return false}$.ajax({url:"/openapi/sendMsg.php",type:"POST",data:{event:"send_to_conversation",cid:a.cid,sender:dd.userid,content:d,corpId:_config.corpId},dataType:"json",timeout:900,success:function(f,e,h){var g=f;logger.i("sendMsg: "+JSON.stringify(f));if(g.errcode==0){logger.i("sendMsg: 发送成功");dd.biz.chat.open({cid:a.cid,onSuccess:function(i){},onFail:function(i){}})}else{logger.e("sendMsg: 发送失败"+g.errmsg)}},error:function(g,f,e){logger.e(f+", "+e)}})},onFail:function(c){}})}},onFail:function(a){}})});$("#J_Share_Button").on("click",function(){var b=$(this);var d=b.data("method");var a=b.data("action");var c=b.data("param")||{};if(typeof c==="string"){c=JSON.parse(c);logger.i("scan: "+c)}if(c.corpId){c.corpId=_config.corpId;if(c.id){c.id=_config.users[0]}if(c.users){c.users=_config.users}}if(c.params&&c.params.corpId){c.params.corpId=_config.corpId;if(c.params.id){c.params.id=_config.users[0]}if(c.params.users){c.params.users=_config.users}}dd.device.notification.toast({global:true,text:"扫描书背后的条形码，分享可得漂流币",duration:2,delay:0});sleep(1200);c.onSuccess=function(e){if(a==="alert"){dd.device.geolocation.get({onSuccess:function(f){dd.address=f.address;dd.latitude=f.latitude;dd.longitude=f.longitude;dd.device.notification.alert({title:d,message:JSON.stringify(c,null,4)+"\n响应："+JSON.stringify(e,null,4)})},onFail:function(f){logger.e("fail: "+JSON.stringify(f))}})}else{if(a==="share"){info=JSON.stringify(e);$.ajax({url:"/api/spaceShare",type:"POST",data:{event:"space_share",userId:dd.userid,corpId:_config.corpId,info:info,address:dd.address,latitude:dd.latitude,longitude:dd.longitude},dataType:"json",timeout:900,success:function(h,f,j){logger.i("data: "+h);var i=JSON.parse(h);if(i.errcode===0){logger.i("book_id: "+i.book_id);logger.i("item_id: "+i.item_id);var g="";if(i.score>0){g+="奖励你"+i.score+"漂流币~"}dd.device.notification.toast({global:true,text:"放漂成功！"+g,duration:2,delay:0});window.location.href="/share/detail/"+i.item_id+"?display=1"}},error:function(h,g,f){logger.e(g+", "+f)}})}}};c.onFail=function(e){logger.i("scan: "+e);console.log(d,"调用失败，fail",e)};getMethod(d)(c)});$("#J_Shake_Close").on("click",function(){$("#J_Shake_tip").hide()});$(".J_shake").on("click",function(){$("#J_Shake_tip").show();dd.device.accelerometer.watchShake({sensitivity:12,frequency:100,callbackDelay:150,onSuccess:function(a){dd.device.notification.vibrate({duration:300,onSuccess:function(){},onFail:function(){}});$.ajax({url:"/api/spaceShake",type:"POST",data:{event:"space_shake",userId:dd.userid,corpId:_config.corpId},dataType:"json",timeout:900,success:function(c,b,e){logger.i("data: "+c);var d=JSON.parse(c);if(d.errcode===0){logger.i("book_id: "+d.book_id);logger.i("item_id: "+d.item_id);if(d.msg!=""){dd.device.notification.alert({title:"温馨提示",message:d.msg})}if(d.item_id>0){window.location.href="/share/detail/"+d.item_id+"?display=1&shake=1"}}},error:function(d,c,b){logger.e(c+", "+b)}});dd.device.notification.vibrate({duration:300,onSuccess:function(){dd.device.accelerometer.clearShake({})},onFail:function(){}})},onFail:function(a){console.log("error",a)}})});$(".J_method_btn").on("click",function(){var b=$(this);var d=b.data("method");var a=b.data("action");var c=b.data("param")||{};if(typeof c==="string"){c=JSON.parse(c)}if(c.corpId){c.corpId=_config.corpId;if(c.id){c.id=_config.users[0]}if(c.users){c.users=_config.users}}if(c.params&&c.params.corpId){c.params.corpId=_config.corpId;if(c.params.id){c.params.id=_config.users[0]}if(c.params.users){c.params.users=_config.users}}c.onSuccess=function(e){console.log(d,"调用成功，success",e);if(a==="alert"){dd.device.notification.alert({title:d,message:"传参："+JSON.stringify(c,null,4)+"\n响应："+JSON.stringify(e,null,4)})}};c.onFail=function(e){dd.device.notification.alert({title:d,message:JSON.stringify(c,null,4)+"\n响应："+JSON.stringify(e,null,4)});console.log(d,"调用失败，fail",e)};getMethod(d)(c)})});dd.error(function(a){logger.e("dd error: "+JSON.stringify(a))});

